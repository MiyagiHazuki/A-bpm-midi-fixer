# MIDI Repair Tool - BPM可视化与分段

参考 Mid2Meow 项目的可视化实现，为 MIDI Repair Tool 添加了BPM可视化和分段功能。

## 功能概述

### 1. BPM可视化
- 显示MIDI文件中的BPM变化曲线
- 显示音符密度直方图
- 支持缩放和平移查看细节

### 2. 分段管理
- **添加分段**: 右键点击波形区域的空白处，选择"在此处添加分界线"
- **删除分段**: 右键点击分界线，选择"删除此分界线"
- **拖拽边界**: 鼠标左键按住分界线并拖动以调整分段位置
- **编辑分段**: 右键点击分段区域，选择"编辑分段设置"

### 3. BPM分段设置
- 为每个分段独立设置BPM值
- 添加分段描述信息
- 实时显示音符数和时长
### 4. 导出功能
- **智能导出**: 自动根据用户操作选择导出内容
  - 如果已创建分段 → 导出分段BPM的MIDI
  - 如果使用了一键修复 → 导出固定BPM的MIDI
- **一键修复**: 快速修复MIDI文件的BPM问题

```bash
pip install -r requirements.txt
```

## 使用方法

### 启动程序
```bash
python run.py
```

### 基本工作流程

1. **导入MIDI文件**
   - 点击"浏览..."按钮选择MIDI文件
   - 程序会自动加载并显示BPM曲线和音符密度

2. **创建分段**
   - 在波形区域右键点击
   - 选择"在此处添加分界线"创建新分段

3. **设置分段BPM**
   - 右键点击已创建的分段
   - 选择"编辑分段设置"
   - 设置该分段的BPM值和描述

4. **调整分段边界**
   - 左键按住分界线并拖动
   - 调整分段的开始或结束时间

5. **导出MIDI**
   - 点击"\u2794 导出 MIDI"按钮
   - 程序会根据您的操作自动选择导出内容：
     * 有分段时：导出包含分段BPM变化的MIDI
     * 修复后：导出固定BPM的MIDI
   - 选择保存位置
   - 保存MIDI文件
### 快捷键

- `Ctrl+Z`: 撤销上一步操作
- `Ctrl+Y`: 重做上一步操作

## 界面说明

### BPM曲线
- 蓝色曲线显示MIDI文件中的原始BPM变化
- 标签显示关键点的BPM值
- 垂直刻度表示时间（分:秒）

### 音符密度
- 底部直方图显示音符密度
- 颜色深浅表示音符数量多少

### 分段显示
- 灰色: 默认BPM (120)
- 绿色: 快于默认BPM
- 红色: 慢于默认BPM
- 选中分段: 红色边框
- 分段内显示BPM值标签

### 工具提示
- 鼠标悬停在分段上显示详细信息
- 包括: BPM、时长、音符数

## 文件结构

```
src/midi_repair/
├── gui/
│   ├── app.py              # 主GUI程序
│   ├── models.py           # 数据模型 (Section, BPMChangePoint)
│   ├── visualization.py    # 可视化Canvas组件
│   ├── dialogs.py         # 分段设置对话框
│   └── export.py          # 分段导出功能
├── core/
│   ├── repair.py          # MIDI修复核心功能
│   └── analyzer.py        # MIDI分析功能
└── cli.py                # 命令行接口
```

## 技术特点

### 参考Mid2Meow的实现
- ✅ WaveformCanvas的交互模式（拖拽、右键菜单）
- ✅ 分段背景色编码（绿色=快、红色=慢）
- ✅ 边界线样式（红色虚线）
- ✅ 撤销/重做栈实现

### 新增特性
- ✅ BPM变化曲线显示（新增）
- ✅ 音符密度直方图（新增）
- ✅ 分段BPM独立设置（新增）
- ✅ 分段导出功能（新增）

### 代码质量
- ✅ 类型注释完整
- ✅ 文档字符串详细
- ✅ 错误处理完善
- ✅ 模块化设计良好

## 依赖项

- mido >= 2.0.0 (MIDI文件处理)
- numpy >= 1.20.0 (数值计算和可视化)
- tkinter (Python标准库，GUI框架)

## 兼容性

- Python 3.7+
- Windows/macOS/Linux
- mido 2.0+
- numpy 1.20+

## 高级功能

- 拖拽分段边界精确调整
- Ctrl+Z撤销/Ctrl+Y重做
- 查看工具提示了解详细信息
- 使用"一键修复"快速修复BPM问题

## 示例

### 基本使用流程
1. 导入MIDI文件
2. 查看BPM曲线和音符密度
3. 右键添加分段（可选）
4. 点击"\u2794 导出 MIDI"保存结果

本项目参考了 Mid2Meow 项目的可视化实现，遵循相应的开源许可协议。
